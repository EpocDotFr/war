{% extends 'layout.html' %}

{% block title %}Results{% endblock %}

{% block jsfiles %}
      {{ super() }}
      {% if not sample['done'] %}
          <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
          <script src="https://js.pusher.com/3.2/pusher.min.js"></script>
      {% endif %}
{% endblock %}

{% block content %}
    <div id="processing" {% if sample['done'] %}style="display: none"{% endif %}>
        <p class="alert info">Your sample is now being processed! The results are automatically displayed below (no need to refresh this page!).</p>
        <p>You can close this page and access it at any given time using this link:</p>
        <p style="text-align: center !important;"><input type="text" readonly value="{{ url_for('results', sample_id=sample['_id'], _external=True) }}" onClick="this.setSelectionRange(0, this.value.length)"></p>
    </div>
    <div id="done" {% if not sample['done'] %}style="display: none"{% endif %}>
        <p class="alert success">Your sample finished being processed! Here are the final results.</p>
    </div>

    <div id="results">
        {% for result in results %}
            <h2 id="{{ result.audio_database_id }}">{{ result.audio_database_name }} said...</h2>
            {% if result.status == 'failure' %}
                <p>Sorry, I don't know :/</p>
            {% elif result.status == 'error' %}
                <p>Sorry, an error occured :/ We have been informed about it.</p>
            {% elif result.status == 'success' %}
                <p>It is <strong>{{ result.data.artist }}</strong> with <strong>{{ result.data.title }}</strong>{% if result.data.album %} from the album <strong>{{ result.data.album }}</strong>{% endif %}. Search on <a href="https://www.youtube.com/results?search_query={{ result.data.search_terms }}">Youtube</a>, <a href="https://www.deezer.com/search/{{ result.data.search_terms }}">Deezer</a> or <a href="https://open.spotify.com/search/{{ result.data.search_terms }}">Spotify</a>?</p>
            {% endif %}
        {% endfor %}
    </div>

    <p style="text-align: center !important;"><a href="{{ url_for('home') }}" class="button">Â« Back</a></p>

    {% if not sample['done'] %}
        <script>
        Zepto(function () {
            {% if config['DEBUG'] %}Pusher.logToConsole = true;{% endif %}

            var div_processing = $('div#processing');
            var div_done = $('div#done');
            var div_results = $('div#results');

            var pusher = new Pusher('{{ config['PUSHER']['KEY'] }}', {
                cluster: '{{ config['PUSHER']['CLUSTER'] }}',
                encrypted: true
            });

            var channel = pusher.subscribe('results-{{ sample['_id'] }}');

            channel.bind('error', function(message) {
                div_results.append('<h2 id="'+message.audio_database_id+'">'+message.audio_database_name+' said...</h2><p>Sorry, an error occured :/ We have been informed about it.</p>');
            });

            channel.bind('failure', function(message) {
                div_results.append('<h2 id="'+message.audio_database_id+'">'+message.audio_database_name+' said...</h2><p>Sorry, I don\'t know :/</p>');
            });

            channel.bind('success', function(message) {
                var album_string = '';

                if (message.data.album) {
                    album_string = ' from the album <strong>'+message.data.album+'</strong>';
                }

                div_results.append('<h2 id="'+message.audio_database_id+'">'+message.audio_database_name+' said...</h2><p>It is <strong>'+message.data.artist+'</strong> with <strong>'+message.data.title+'</strong>'+album_string+'. Search on <a href="https://www.youtube.com/results?search_query='+message.data.search_terms+'">Youtube</a>, <a href="https://www.deezer.com/search/'+message.data.search_terms+'">Deezer</a> or <a href="https://open.spotify.com/search/'+message.data.search_terms+'">Spotify</a>?</p>');
            });

            channel.bind('done', function(message) {
                div_processing.remove();
                div_done.show();
            });
        });
        </script>
    {% endif %}
{% endblock %}